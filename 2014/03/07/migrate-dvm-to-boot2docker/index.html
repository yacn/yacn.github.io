<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta name="description" /><meta content="docker personal dvm osx boot2docker troubleshooting" name="keywords" /><meta content="yacn" name="author" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/rss-feed" rel="alternate" title="RSS Feed" type="application/rss+xml" /><link href="/img/favicon.ico" rel="icon" type="image/x-icon" /><link href="/img/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="//fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans" rel="stylesheet" type="text/css" /><link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="/css/yacn.css" rel="stylesheet" type="text/css" /><title>Migrating from dvm to boot2docker</title></head><body><div class="header"><nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/index.html">YACN</a></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li><a href="/blog.html">Blog</a></li><li><a href="/is3500/blog.html">IS3500 Blog</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/about.html">About</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="icon-header" href="https://github.com/yacn"><i class="icon-github icon-2x"></i></a><li><a class="icon-header" href="https://twitter.com/yaclevername"><i class="icon-twitter icon-2x"></i></a><li><a class="icon-header" href="https://www.linkedin.com/in/idboehman"><i class="icon-linkedin icon-2x"></i></a><li><a class="icon-header" href="http://yacn.me/rss-feed"><i class="icon-rss icon-2x"></i></a><li><a class="icon-header" href="/plex.html"><i class="icon-pms icon-2x"></i></a></li></li></li></li></li></ul></div></div></nav></div><div class="content"><div class="container"><div class="row"><div class="col-md-12"><h1>Migrating from <code>dvm</code> to <code>boot2docker</code></h1><h2>Preconditions</h2><p>About two weeks ago, I wrote about how I got <a href="https://fnichol.github.io/dvm/">dvm</a> working with <a href="https://www.docker.io">Docker</a> using a specified network range for the <code>docker0</code> bridge. A quick overview of dvm, for the uninitiated: It's a Bash script wrapped around a <code>Vagrantfile</code> which uses a Vagrant box based off the <a href="http://boot2docker.io">boot2docker</a> image. The original boot2docker script itself is simply a Bash script wrapped around the <a href="http://www.virtualbox.org/manual/ch08.html">VBoxManage</a> command. There's an <a href="https://github.com/boot2docker/boot2docker-cli">on-going effort</a> to rewrite the boot2docker script in <a href="https://golang.org">Go</a>, but it is currently experimental. Anyways, dvm uses Vagrant to interact with VirtualBox, where Vagrant itself is a wrapper around interacting with VirtualBox. Since it uses Vagrant, it needs <a href="https://github.com/mitchellh/boot2docker-vagrant-box/">a Vagrant Box</a> to create the VM, meaning that each time a new boot2docker image is released, a new Vagrant Box must also be created before dvm can use the latest version.</p><p>You've probably already guessed why I'm migrating away, there's just simply too many moving pieces that can each become a bottleneck. dvm can bottleneck with bugfixes while I can also be bottlenecked by waiting for new Vagrant Boxes to be released. To eliminate this, I have decided to move away from using dvm to using the original boot2docker (I'm actually using boot2docker-cli, the Go port of the tool, but more on that later).</p><h2>Moving previous work</h2><p>The downside to this is that I needed to find a way to perform the same customizations I was using with dvm to change the network range of the <code>docker0</code> interface. With dvm, adding local customizations is as simple as editing the provisioning script which is run wheneve the VM is created. Using boot2docker itself wasn't as straight forward. As boot2docker is run entirely from memory, a persistence disk must be attached to the VM to provide a place to save things so they won't be deleted. While dvm handled this in the <code>Vagrantfile</code>, the boot2docker script actually creates it for you as well and mounts it to <code>/mnt/sda1</code>. To add local customizations, you can place what you want to do into a script titled <code>bootlocal.sh</code> and place that inside <code>/var/lib/boot2docker</code> (which is symlinked to <code>/mnt/sda1/var/lib/boot2docker</code>).</p><p>The tasks I needed to take care of in this script were to:</p>
<ol>
  <li>Install bridge utils if not present</li>
  <li>Modify Docker's init script to add the <code>--bip</code> option</li>
  <li>Create a folder on the persistence disk for use as a mount point for SSHFS</li>
</ol><p>To accomplish 1 and 2, I was able to re-use most of the work done in dvm's <code>Vagrantfile</code>. For 3, it was simply a matter of creating a folder. Once I had written the script, however, I realized I needed to get it on the VM disk before it'd be useful! I could have simply re-typed it while SSH'd into the VM, but that's not very DRY and I'll likely need to add more files to the VM at a later point. Luckily, the boot2docker maintainers <a href="https://github.com/boot2docker/boot2docker/blob/master/doc/WORKAROUNDS.md#folder-sharing">provide a workaround</a> using <a href="https://osxfuse.github.io">FUSE for OS X and SSHFS</a>, so I was able to mount a folder from my host laptop on the VM with minimal fuss.</p><p>The one issue I ran into was with the command used to mount the folder. In the steps given, they have you create a file <code>b2d-passwd</code> containing the password for the docker user on the VM. Then, when you go to mount the folder on the VM, they have you run:</p>
<pre><code>sshfs docker@localhost:/mnt/sda1/myapp ~/myapp -oping_diskarb,volname=b2d-myapp -p 2022 -o reconnect -o UserKnownHostsFile=/dev/null -o password_stdin &lt; ~/.boot2docker/b2d-passwd
</code></pre><p>where <code>/mnt/sda1/myapp</code> is the mount-point on the VM and <code>~/myapp</code> is the folder on the host being shared with the VM. The part that I had issue with was <code>-o password_stdin &lt; ~/.boot2docker/b2d-passwd</code>. No matter what I tried, I always got a timeout error while waiting for the prompt. When I removed that part of the command, the reason for this became immediately obvious: I was being asked <code>yes/no</code> about the VM's SSH key, meaning the prompt would never show! As of now, I haven't found a workaround, it is easy enough to type <code>yes</code> and <code>tcuser</code> when I want to mount a folder.</p><h2>Bumps in the road</h2><p>Once that was working, it was trivial to move the <code>bootlocal.sh</code> script from the shared folder to its place in <code>/var/lib/boot2docker</code>. Then I simply logged out, stopped the VM, and copied the VMDK to a safe place. Now when I want to create a new boot2docker VM, I just need to copy the VMDK into place (<code>~/.boot2docker</code>) before running <code>boot2docker init</code>. Once that completes, I have a fresh VM with all my local customizations. The next logical step for this would be to create a customized ISO that includes the <code>bootlocal.sh</code> to remove the need to remember to copy the VMDK back into place when creating a new VM.</p><p>However, this is where the issues have started springing up. When I tried to run Test Kitchen through the new boot2docker VM, I ran into the issue where <a href="https://github.com/portertech/kitchen-docker/issues/24">the VM hangs waiting for the container to be ready</a>. Reading through that thread it seemed like any issues with the software itself (Test Kitchen, kitchen-docker, boot2docker, docker itself, etc) should have been fixed in the versions I am using (Test Kitchen 1.2.1, kitchen-docker installed from GitHub, boot2docker 0.6.0, docker 0.8.1). This issue seemed familiar though, and upon further digging I narrowed it down to routes getting crossed and confused. Aha! This was why I moved to dvm in the first place. dvm is slightly different from the default boot2docker because it creates a <a href="http://www.virtualbox.org/manual/ch06.html#network_hostonly">host-only network</a> to run Docker on. This solves the issue of criss-crossed routes, so I set out to find if this feature existed in boot2docker.</p><p>In my research, I found this <a href="https://github.com/boot2docker/boot2docker/pull/198">hostonly interface-related</a> pull request. At the time of this writing, the pull request is still open, so this feature hasn't made its way into the main boot2docker. Fortunately though, at the bottom of the pull request the discussion gets moved to <a href="https://github.com/boot2docker/boot2docker-cli/pull/42">this pull request</a> on the new <code>boot2docker-cli</code> repo. That request was merged, so the feature in some form exists. This is why I am as of now using the <code>boot2docker-cli</code> tool instead of the normal one.</p><h2>What's left to do</h2><p>Once that was all figured out, my next move was to try to get test kitchen and kitchen-docker working together with this new boot2docker VM. I re-created my VMDK w/ the <code>bootlocal.sh</code> script and tried to run <code>kitchen test</code>. Unfortunately, this fails right after pulling in the ubuntu images. Looking through the logs, it seems like the containers are unable to access the Internet. Also, the boot2docker-cli creates a new hostonly interface for each VM it creates, but it also never deletes them after the VMs are deleted. This also leads to issues with criss-crossed routes as packets are being sent to the wrong hostonly interface. Lastly, I seem to be unable to run <code>boot2docker-cli ssh</code> or <code>boot2docker ssh</code> to log into the VMs while I'm connected to my work's VPN. This is strange since I was able to use both of those commands just fine while at work, but as soon as I turned my VPN off, they both started working. I suspect it is also an issue of criss-crossed routes. </p><p>In summary, the following work is left to do before the migration from dvm to boot2docker is complete:</p>
<ol>
  <li>Figure out why containers cannot reach the internet</li>
  <li>Modify <code>boot2docker-cli init/delete</code> to keep track of the interfaces it creates so they can be deleted with the VM.</li>
  <li>Figure out why I'm unable to SSH into the VM while logged into my work's VPN.</li>
</ol><p>I've started reading about Go so that I can contribute patches, so hopefully I should be able to make some progress on number 2 before too long. It seems to be a simple matter of creating a map of the interfaces created to the VMs their attached to, but there's all of Go to grapple with first. It's going to be a busy upcoming week too, as the 2014 Northeast CCDC is this Friday, Saturday, and Sunday at UNH. Fun fun fun, so much to do, so little time.</p><div id="post-tags">Tags: <a href="/tags/#docker">docker </a><a href="/tags/#personal">personal </a><a href="/tags/#dvm">dvm </a><a href="/tags/#osx">osx </a><a href="/tags/#boot2docker">boot2docker </a><a href="/tags/#troubleshooting">troubleshooting </a></div><div class="shares"><a class="twitter-share-button" data-via="yaclevername" href="https://twitter.com/share">Tweet</a></div><br /><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'yacn';var disqus_identifier = 'http://yacn.me' + window.location.pathname;var disqus_url = disqus_identifier;(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script><script src="/js/yacn.js"></script><div class="footer"><div class="container"><div class="row"><div class="col-md-12"><p>Built with <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="https://github.com/nakkaya/static">Static</a>. Based off of <a href="http://crsmithdev.com">Chris Smith</a>'s site<br />&copy; 2014 <a href="http://yacn.me">Yet Another Clever Name</a></p></div></div></div></div></div></div></body></html>