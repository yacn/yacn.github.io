<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta name="description" /><meta content="docker test-kitchen dvm" name="keywords" /><meta content="yacn" name="author" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/rss-feed" rel="alternate" title="RSS Feed" type="application/rss+xml" /><link href="/img/favicon.ico" rel="icon" type="image/x-icon" /><link href="/img/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="//fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans" rel="stylesheet" type="text/css" /><link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="/css/yacn.css" rel="stylesheet" type="text/css" /><title>Fixing dvm with Test Kitchen</title></head><body><div class="header"><nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/index.html">YACN</a></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li><a href="/blog.html">Blog</a></li><li><a href="/is3500/blog.html">IS3500 Blog</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/about.html">About</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="icon-header" href="https://github.com/yacn"><i class="icon-github icon-2x"></i></a><li><a class="icon-header" href="https://twitter.com/yaclevername"><i class="icon-twitter icon-2x"></i></a><li><a class="icon-header" href="https://www.linkedin.com/in/idboehman"><i class="icon-linkedin icon-2x"></i></a><li><a class="icon-header" href="http://yacn.me/rss-feed"><i class="icon-rss icon-2x"></i></a></li></li></li></li></ul></div></div></nav></div><div class="content"><div class="container"><div class="row"><div class="col-md-12"><h1>Fixing dvm with Test Kitchen</h1><h2>Finding dvm</h2><p>For the past few weeks at work, I've been conducting research on the side with the goal of setting up a continuous integration environment for our Chef cookbooks. I've decided to use <a href="https://kitchen.ci">Test Kitchen</a> with the <a href="https://github.com/portertech/kitchen-docker">kitchen-docker</a> driver as the base for our integration testing framework (of which the specifics are out of the scope of this post).</p><p>Now that I'd chosen our stack, it was time to get kitchen-docker, Test Kitchen, and Docker working together. I needed a solution which would allow me to work with Docker locally on OS X. Luckily, there are two related projects allowing me to do just that, <a href="https://github.com/fnichol/dvm">dvm</a> and <a href="https://github.com/boot2docker/boot2docker">boot2docker</a> (dvm is actually just a wrapper around Vagrant using a <a href="https://github.com/mitchellh/boot2docker-vagrant-box">boot2docker box</a>).</p><h2>Bumpy start</h2><p>The first issue I ran into was Docker choosing a network range which conflicted with the network range our work runs in. I'd actually run into this issue before, several months ago when I was first testing out Docker. At the time, there was no immediate workaround, so put it in the back of my mind for later. Docker has since been updated to attempt to be smart about choosing the network range by looking for any conflicting networks. However, this issue still affects us because Docker is being run through a VM, meaning it will not detect the conflicting network.</p><p>A more recent addition to Docker is the <code>--bip=&quot;&quot;</code> option, which you can use to specify a CIDR range for the <code>docker0</code> bridge that Docker creates. However, to use this new feature with dvm, I was going to need to make some modifications to support it.</p><h2>Modifying dvm</h2><p>The way dvm works is by allowing you to set configuration options in a file <code>~/.dvm/dvm.conf</code>. Those settings are environment variables which are exported when creating the boot2docker VM. To add support for <code>--bip</code>, I added the configuration directive <code>DOCKER0_CIDR</code> to the config file. I then modified the <code>Vagrantfile</code> to use the new argument if specified. I saved my changes, crossed my fingers, and typed <code>dvm up</code>. To my dismay, passing in that option didn't seem to affect anything!</p><h2>(Re)building the bridge</h2><p>After some more reading, I learned that if the <code>docker0</code> bridge has already been created, the IP range assigned to it will not be affected by the <code>--bip</code> option. To use the option, you need to first make sure the <code>docker0</code> bridge does not exist when starting Docker, meaning that if it does exist, it will need to be deleted.</p><p>Deleting a bridge seems simple enough, you just need to run <code>brctl delbr nameofbridge</code>. Unfortunately, the <code>brctl</code> utility is not included in the release of <a href="http://www.tinycorelinux.net/">Tiny Core Linux</a> used by boot2docker. I now set off to find a bridge-utils package I could install on the distro. Fortunately I didn't need to dig for too long, there was a link to such a package in <a href="https://github.com/boot2docker/boot2docker/blob/master/doc/FAQ.md">one of the docs</a> for boot2docker.</p><p>Now all I needed to do was update the <code>Vagrantfile</code> to check whether or not the <code>DOCKER0_CIDR</code> option was set, and if so, setup the arguments, stop the currently running Docker daemon, install the bridge utils, and remove the <code>docker0</code> bridge. I ran <code>dvm up</code> and low and behold, it worked!</p><p>By this time I'm feeling pretty good, I've gotten much farther than ever before. I run <code>kitchen create</code> to create a container and, you guessed it, it worked! Running <code>kitchen converge</code> also worked as expected, which is great as now my container can access hosts within our local network as well as the internet at large! Satisfied with myself, I ran <code>kitchen destroy</code> to delete the containers. Oh no, it doesn't work!</p><h2>One last jam</h2><p>Unfortunately I ran into a jam (damn you Chris Christie!), running <code>kitchen destroy</code> throws an exception! Looking at the message returned, it seems to be an issue related with trying to stop and remove the container, something appears to be holding a lock over it:</p>
<pre><code>|ruby-1.9.3-p448| isaacs-air in ~/git/yacn/dvm/tmp
± |fix/unable-to-stop-delete-containers ✗| → kitchen destroy
-----&gt; Starting Kitchen (v1.2.1)
-----&gt; Destroying &lt;default-ubuntu&gt;...
368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca
&gt;&gt;&gt;&gt;&gt;&gt; ------Exception-------
&gt;&gt;&gt;&gt;&gt;&gt; Class: Kitchen::ActionFailed
&gt;&gt;&gt;&gt;&gt;&gt; Message: Failed to complete #destroy action: [Expected process to exit with [0], but received &#39;1&#39;
---- Begin output of docker -H tcp://192.168.42.43:4243 rm 368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca ----
STDOUT:
STDERR: Error: container_delete: Cannot destroy container 368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca: Driver aufs failed to remove root filesystem 368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca: rename /var/lib/docker/aufs/mnt/368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca /var/lib/docker/aufs/mnt/368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca-removing: device or resource busy
2014/02/24 14:07:29 Error: failed to remove one or more containers
---- End output of docker -H tcp://192.168.42.43:4243 rm 368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca ----
Ran docker -H tcp://192.168.42.43:4243 rm 368ccd5979763ce38c072d9751417ba457827146548d7a04676b3a5795c806ca returned 1]
&gt;&gt;&gt;&gt;&gt;&gt; ----------------------
&gt;&gt;&gt;&gt;&gt;&gt; Please see .kitchen/logs/kitchen.log for more details
&gt;&gt;&gt;&gt;&gt;&gt; Also try running `kitchen diagnose --all` for configuration
</code></pre><p>Yikes, that doesn't seem good. Well, lets see if the container is still there. I logged into the <code>dvm</code> machine via <code>dvm ssh</code> and ran <code>docker ps</code></p>
<pre><code>|ruby-1.9.3-p448| isaacs-air in ~/git/yacn/dvm/tmp
± |fix/unable-to-stop-delete-containers ✗| → dvm ssh
                        ##        .
                  ## ## ##       ==
               ## ## ## ##      ===
           /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;\___/ ===
      ~~~ {~~ ~~~~ ~~~ ~~~~ ~~ ~ /  ===- ~~~
           \______ o          __/
             \    \        __/
              \____\______/
 _                 _   ____     _            _
| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __
| &#39;_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ &#39;__|
| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |
|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|
boot2docker: 0.5.4
docker@boot2docker:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
docker@boot2docker:~$ exit
</code></pre><p>Hmm, so it looks like the container was actually stopped. Researching this issue led me to <a href="https://github.com/dotcloud/docker/issues/2714#issuecomment-34408878">this</a> thread. The issue seems to be related to using a symlink where Docker expects its runtime root to be. By default, this is <code>/var/lib/docker</code>, but in boot2docker, this has been symlinked to <code>/mnt/sda/var/lib/docker</code>. This causes Docker to be unable to stop or remove any of the containers it creates, as it doesn't seem to follow the symlink. </p><p>The remedy is to use the <code>-g</code> option to set the path to use as the root of Docker's runtime to the directory the symlink points to. Looking at the file in boot2docker where the Docker daemon is started (<a href="https://github.com/boot2docker/boot2docker/blob/master/rootfs/rootfs/usr/local/etc/init.d/docker#L18">/usr/local/etc/init.d/docker</a>), it seems like the <code>-g</code> option should already be provided. All the more curious and needs further investigation.</p><h2>A <code>sed</code> to far</h2><p>The culprit, it turns out, is the <code>Vagrantfile</code> used by dvm! In the <a href="https://github.com/fnichol/dvm/blob/master/Vagrantfile#L89">provisioning script</a> used to restart the Docker daemon with the args provided in <code>DOCKER_ARGS</code>, there's a <code>sed</code> command which looks like:</p>
<pre><code>sed -i -e &#39;s|docker -d .* $EXPOSE_ALL|docker -d #{args}|&#39; $INITD
</code></pre><p>where: </p>
<ul>
  <li><code>$INITD</code> is <code>/usr/local/etc/init.d/docker</code></li>
  <li><code>$EXPOSE_ALL</code> is a variable set in that file</li>
  <li><code>#{args}</code> is the string interpolation of the <code>args</code> defined in <code>DOCKER_ARGS</code>.</li>
</ul><p>This command is only run if you modify either <code>args</code> or <code>DOCKER_ARGS</code>, which is how I believe it slipped through the cracks.</p><p>What happens is the part of the line in <code>/usr/local/etc/init.d/docker</code> that is specifying the <code>-g</code> option is wiped out when the new <code>args</code> are added to the command. There were a few options to solving this:</p>
<ol>
  <li>Update the README to state that if you modify <code>DOCKER_ARGS</code>, you must make sure to include the <code>-g</code> option</li>
  <li>Update the <code>Vagrantfile</code> to check if <code>DOCKER_ARGS</code> is modified, and if so, to check that it includes the <code>-g</code> option, adding it if it does not.</li>
  <li>Update the <code>sed</code> command to save the <code>-g</code> option and use a backreference to it.</li>
</ol><p>I chose to implement option 3 as it seemed the simplest and most transparent way to accomplish the goal.</p><h2>One last run</h2><p>With the changes in place, it was time to test them out again. I created a new <code>dvm</code> VM with the updated <code>Vagrantfile</code> and a <code>dvm.conf</code> specifying <code>DOCKER0_CIDR</code>. Once that was created, I checked to make sure the <code>docker0</code> bridge had the new IP range. So far, so good, so I ran <code>kitchen create</code> and watched as Test Kitchen pulled in the Ubuntu repo and created a container for me. Still looking good, but all of this did work before. I enter <code>kitchen destroy</code> for the final test and...</p>
<pre><code>|ruby-1.9.3-p448| isaacs-air in ~/git/yacn/dvm/tmp
± |fix/unable-to-stop-delete-containers ✗| → kitchen destroy
-----&gt; Starting Kitchen (v1.2.1)
-----&gt; Destroying &lt;default-ubuntu&gt;...
2118a87d5cf2f5d6bc502a3f086b4ab828e6c3023624e2da9e8590eae043ec1f
2118a87d5cf2f5d6bc502a3f086b4ab828e6c3023624e2da9e8590eae043ec1f
Finished destroying &lt;default-ubuntu&gt; (0m0.14s).
-----&gt; Kitchen is finished. (0m0.20s)

|ruby-1.9.3-p448| isaacs-air in ~/git/yacn/dvm/tmp
± |fix/unable-to-stop-delete-containers ✗| → kitchen list
Instance Driver Provisioner Last Action
default-ubuntu Docker ChefZero &lt;Not Created&gt;
</code></pre><p>WooHoo! It works! </p><h2>Conclusion</h2><p>To summarize, I needed to update dvm to allow me to set the IP range of the <code>docker0</code> bridge. This required me to install bridge-utils for <code>brctl</code> to remove the previously created <code>docker0</code> bridge before my new IP range could take effect. Once that was implemented, I discovered a bug in the provisioning script for dvm causing which prevented stopping or deleting containers. Both fixes are currently open as pull requests:</p>
<ul>
  <li><a href="https://github.com/fnichol/dvm/pull/21">sed fix</a></li>
  <li><a href="https://github.com/fnichol/dvm/pull/22">Setting docker0 CIDR range</a></li>
</ul><div id="post-tags">Tags: <a href="/tags/#docker">docker </a><a href="/tags/#test-kitchen">test-kitchen </a><a href="/tags/#dvm">dvm </a></div><div class="shares"><a class="twitter-share-button" data-via="yaclevername" href="https://twitter.com/share">Tweet</a></div><br /><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'yacn';var disqus_identifier = 'http://yacn.me' + window.location.pathname;var disqus_url = disqus_identifier;(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script><script src="/js/yacn.js"></script><div class="footer"><div class="container"><div class="row"><div class="col-md-12"><p>Built with <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="https://github.com/nakkaya/static">Static</a>. Based off of <a href="http://crsmithdev.com">Chris Smith</a>'s site<br />&copy; 2014 <a href="http://yacn.me">Yet Another Clever Name</a></p></div></div></div></div></div></div></body></html>