<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml"><head><meta content="text/html; charset=UTF-8" http-equiv="content-type" /><meta name="description" /><meta content="sensu chef monitoring stability" name="keywords" /><meta content="yacn" name="author" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/rss-feed" rel="alternate" title="RSS Feed" type="application/rss+xml" /><link href="/img/favicon.ico" rel="icon" type="image/x-icon" /><link href="/img/favicon.ico" rel="shortcut icon" type="image/x-icon" /><link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet" type="text/css" /><link href="//fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans" rel="stylesheet" type="text/css" /><link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="/css/yacn.css" rel="stylesheet" type="text/css" /><title>Sensu EC2 Node Handler</title></head><body><div class="header"><nav class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container"><div class="navbar-header"><button class="navbar-toggle" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/index.html">YACN</a></div><div class="collapse navbar-collapse navbar-ex1-collapse"><ul class="nav navbar-nav"><li><a href="/blog.html">Blog</a></li><li><a href="/is3500/blog.html">IS3500 Blog</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/about.html">About</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a class="icon-header" href="https://github.com/yacn"><i class="icon-github icon-2x"></i></a><li><a class="icon-header" href="https://twitter.com/yaclevername"><i class="icon-twitter icon-2x"></i></a><li><a class="icon-header" href="https://www.linkedin.com/in/idboehman"><i class="icon-linkedin icon-2x"></i></a><li><a class="icon-header" href="http://yacn.me/rss-feed"><i class="icon-rss icon-2x"></i></a></li></li></li></li></ul></div></div></nav></div><div class="content"><div class="container"><div class="row"><div class="col-md-12"><h1>Sensu EC2 Node Handler</h1><h2>The Problem</h2><p>At work, we run <a href="https://sensuapp.org">Sensu</a> as the base for our metrics, monitoring, and alerting pipeline. A while back, we were running into an issue with phantom keepalive alerts due to how Sensu was determining whether or not a node still existed. The way it was determining this was to query our <a href="https://www.getchef.com">Chef</a> server to check whether or not the client and node existed there. However, due to how we provision and terminate nodes (using an internal knife plugin), the clients and nodes on the Chef server are not removed until the next time they are to be created. (Really, we should update the deletion component to remove the clients and nodes, but it is a low priority at this point).</p><p>Due to this workflow, when we would terminate a cluster, we would encounter a "keepalive storm", where we would be flooded with keepalive alerts for the cluster we just terminated. This would cause our Sensu server to become overloaded with queued up events to handle. When our next Chef run would execute, the Sensu server would be signaled to restart. However, due to the massive event queue that had built up, the time needed to restart the process would exceed the threshold set for the service's script, set in <code>/etc/default/sensu</code>. I believe the default was 10 seconds, we increased it to 30 while investigating to try and soothe the inevitable Chef runs.</p><p>Nevertheless, the process would nearly always fail to restart, which caused the Chef run to fail and would leave teh Sensu server in an incorrect state. The remedy this state, we owuld need to manually stop and start each of the Sensu components (API, server, client) manually. This was very annoying and inconveniencing, so I set out to find a fix for the situation.</p><h2>The Solution</h2><p>To solve our phantom keepalives and subsequent "keepalive storms", I created a Sensu handler for the keepalive event. When it handles a keepalive event, instead of checking the Chef server to determine whether the node still exists, it checks EC2. If the node is not found in EC2, it is removed from Sensu as a client.</p><p>When we implemented this handler at work, we were able to eliminate the "keepalive storms" and phantom keepalive alerts, thus increasing the stability of our Sensu server. You can check out the plugin in the official <a href="https://github.com/sensu/sensu-community-plugins/blob/master/handlers/other/ec2_node.rb">Sensu Community Plugins</a> repository on GitHub. Hopefully it will be of some use to others.</p><div id="post-tags">Tags: <a href="/tags/#sensu">sensu </a><a href="/tags/#chef">chef </a><a href="/tags/#monitoring">monitoring </a><a href="/tags/#stability">stability </a></div><div class="shares"><a class="twitter-share-button" data-via="yaclevername" href="https://twitter.com/share">Tweet</a></div><br /><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'yacn';var disqus_identifier = 'http://yacn.me' + window.location.pathname;var disqus_url = disqus_identifier;(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></div></div><script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script><script src="/js/yacn.js"></script><div class="footer"><div class="container"><div class="row"><div class="col-md-12"><p>Built with <a href="https://getbootstrap.com/">Bootstrap</a> and <a href="https://github.com/nakkaya/static">Static</a>. Based off of <a href="http://crsmithdev.com">Chris Smith</a>'s site<br />&copy; 2014 <a href="http://yacn.me">Yet Another Clever Name</a></p></div></div></div></div></div></div></body></html>